    <div class="nueva-compra-container">
      <!-- Header con información de la compra -->
      <mat-card class="header-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>add_shopping_cart</mat-icon>
            Nueva Orden de Compra
          </mat-card-title>
          <mat-card-subtitle>
            Orden #: {{numeroOrden}} | Fecha: {{fechaActual | date:'dd/MM/yyyy'}}
          </mat-card-subtitle>
        </mat-card-header>
      </mat-card>

      <div class="compra-content">
        <!-- Panel Izquierdo - Información del proveedor y productos -->
        <div class="left-panel">
          <form [formGroup]="compraForm" class="compra-form">
            <!-- Información del Proveedor -->
            <mat-card class="proveedor-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>business</mat-icon>
                  Información del Proveedor
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="proveedor-fields">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Seleccionar Proveedor</mat-label>
                    <mat-select formControlName="proveedor" (selectionChange)="onProveedorSelected($event)">
                      <mat-option *ngFor="let proveedor of proveedores()" [value]="proveedor">
                        <div class="proveedor-option">
                          <span class="proveedor-nombre">{{proveedor.persona.nombrecomercial}}</span>
                          <small class="proveedor-ruc">RUC: {{proveedor.persona.numdocumento}}</small>
                        </div>
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <div class="proveedor-info" *ngIf="selectedProveedor">
                    <mat-card class="info-card">
                      <mat-card-content>
                        <div class="proveedor-details">
                          <div class="detail-row">
                            <mat-icon>business</mat-icon>
                            <span>{{selectedProveedor.persona.nombrecomercial}}</span>
                          </div>
                          <div class="detail-row" *ngIf="selectedProveedor.persona.numdocumento">
                            <mat-icon>assignment_ind</mat-icon>
                            <span>RUC: {{selectedProveedor.persona.numdocumento}}</span>
                          </div>
                          <div class="detail-row" *ngIf="selectedProveedor.persona.perdireccion">
                            <mat-icon>phone</mat-icon>
                            <span>{{selectedProveedor.persona.perdireccion}}</span>
                          </div>
                        </div>
                      </mat-card-content>
                    </mat-card>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Información de Entrega -->
            <mat-card class="entrega-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>local_shipping</mat-icon>
                  Información de Entrega
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="entrega-fields">
                  <mat-form-field appearance="outline">
                    <mat-label>Fecha de Entrega</mat-label>
                    <input matInput [matDatepicker]="picker" formControlName="fechaEntrega">
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Número de Guía</mat-label>
                    <input matInput formControlName="numGuia" placeholder="Ingrese número de guía">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Placa del Vehículo</mat-label>
                    <input matInput formControlName="placaVehiculo" placeholder="ABC-123">
                  </mat-form-field>

                  <div class="direccion-fields">
                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Origen</mat-label>
                      <input matInput formControlName="origen" placeholder="Ciudad de origen">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="half-width">
                      <mat-label>Destino</mat-label>
                      <input matInput formControlName="destino" placeholder="Ciudad de destino">
                    </mat-form-field>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Productos a Comprar -->
            <mat-card class="productos-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>inventory_2</mat-icon>
                  Productos a Comprar
                  <mat-chip-set>
                    <mat-chip color="primary">{{compraItems().length}} items</mat-chip>
                  </mat-chip-set>
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <!-- Búsqueda de productos -->
                <div class="product-search">
                  <mat-form-field appearance="outline" class="search-field">
                    <mat-label>Buscar Producto</mat-label>
                    <input matInput
                           [formControl]="searchProductControl"
                           [matAutocomplete]="auto"
                           placeholder="Código, nombre o categoría...">
                    <mat-icon matSuffix>search</mat-icon>
                  </mat-form-field>

                  <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayProduct">
                    <mat-option *ngFor="let product of filteredProducts()"
                                [value]="product"
                                (onSelectionChange)="addProduct(product)">
                      <div class="product-option">
                        <div class="product-info">
                          <span class="product-name">{{product.nombre}}</span>
                          <span class="product-code">Código: {{product.codigo}}</span>
                        </div>
                        <div class="product-stock">
                          <span class="stock-value">Stock: {{product.stockunitario}}</span>
                        </div>
                      </div>
                    </mat-option>
                  </mat-autocomplete>

                  <button mat-raised-button color="accent" (click)="openProductCatalog()">
                    <mat-icon>inventory</mat-icon>
                    Catálogo
                  </button>
                </div>

                <!-- Lista de productos seleccionados -->
                 @if (compraItems().length > 0) {

                <div class="productos-list" >
                  <div class="producto-item" *ngFor="let item of compraItems(); let i = index; trackBy: trackByProduct">
                    <div class="item-info">
                      <h4>{{item.producto.nombre}}</h4>
                      <p class="item-code">Código: {{item.producto.codigo}}</p>
                      <p class="item-category">{{item?.producto?.categoria?.nombre??'Sin categoría'}}</p>
                    </div>
                    <div class="item-controls">
                      <mat-form-field appearance="outline" class="quantity-field">
                        <mat-label>Cantidad</mat-label>
                        <input matInput type="number"
                               [(ngModel)]="item.cantidad"
                               (ngModelChange)="updateItemTotal(item)"
                               min="1">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="price-field">
                        <mat-label>Precio Unit.</mat-label>
                        <input matInput type="number"
                               [(ngModel)]="item.precioUnitario"
                               (ngModelChange)="updateItemTotal(item)"
                               step="0.01">
                        <span matPrefix>S/ </span>
                      </mat-form-field>
                      <div class="subtotal-display">
                        <span class="subtotal-label">Subtotal:</span>
                        <span class="subtotal-value">S/ {{item.subtotal | number:'1.2-2'}}</span>
                      </div>
                      <button mat-icon-button color="warn" (click)="removeProduct(i)" matTooltip="Eliminar">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
                 }@else{
                    <ng-template #noProducts>
                  <div class="no-products">
                    <mat-icon class="empty-icon">inventory_2</mat-icon>
                    <p>No hay productos agregados</p>
                    <small>Busca y selecciona productos para agregar a la orden</small>
                  </div>
                </ng-template>
                 }

               
              </mat-card-content>
            </mat-card>
          </form>
        </div>

        <!-- Panel Derecho - Resumen y Acciones -->
        <div class="right-panel">
          <!-- Resumen de la Compra -->
          <mat-card class="resumen-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>receipt_long</mat-icon>
                Resumen de la Orden
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="resumen-details">
                <div class="resumen-row">
                  <span>Subtotal:</span>
                  <span>S/ {{subtotal() | number:'1.2-2'}}</span>
                </div>
                <div class="resumen-row">
                  <span>IGV (18%):</span>
                  <span>S/ {{igv() | number:'1.2-2'}}</span>
                </div>
                <mat-divider class="divider-margin"></mat-divider>
                <div class="resumen-row total-row">
                  <span>Total:</span>
                  <span>S/ {{total() | number:'1.2-2'}}</span>
                </div>
                <div class="resumen-row">
                  <span>Items:</span>
                  <span>{{totalItems()}} productos</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Observaciones -->
          <mat-card class="observaciones-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>note</mat-icon>
                Observaciones
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Comentarios adicionales</mat-label>
                <textarea matInput
                         formControlName="observacion"
                         rows="4"
                         placeholder="Instrucciones especiales, condiciones de pago, etc."></textarea>
              </mat-form-field>
            </mat-card-content>
          </mat-card>

          <!-- Acciones -->
          <mat-card class="acciones-card">
            <mat-card-content>
              <div class="action-buttons">
                <button mat-button (click)="saveDraft()" [disabled]="compraItems().length === 0">
                  <mat-icon>save</mat-icon>
                  Guardar Borrador
                </button>

                <button mat-raised-button
                        color="primary"
                        (click)="generateOrder()"
                        [disabled]="!compraForm.valid || compraItems().length === 0"
                        class="generate-button">
                  <mat-icon>send</mat-icon>
                  Generar Orden - S/ {{total() | number:'1.2-2'}}
                </button>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Historial Reciente -->
          <mat-card class="historial-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>history</mat-icon>
                Últimas Compras
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="historial-list">
                <div class="historial-item" *ngFor="let compra of historialReciente()">
                  <div class="historial-info">
                    <span class="compra-numero">{{compra.numeroOrden}}</span>
                    <small class="compra-proveedor">{{compra.proveedor.razonSocial}}</small>
                  </div>
                  <div class="historial-monto">
                    <span>S/ {{compra.total | number:'1.2-2'}}</span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </div>
 